
var datos =[ {
    "ms": "TC",
    "ms_name": "Interreg",
    "fund": "TOTAL",
    "year": "2021",
    "planned_eu_amount": 9410256783,
    "n_3_decommitment_amount": -1306860,
    "net_planned_eu_amount": 9408949923,
    "cumulative_initial_pre_financing": 277009954.59,
    "cumulative_additional_initial_pre_financing": 0,
    "recovery_of_initial_pre_financing": 0,
    "net_initial_pre_financing": 277009954.59,
    "cumulative_annual_pre_financing": 1425146510.54,
    "annual_pre_financing_covered_by_expenditure": 273242344.24,
    "recovery_of_annual_pre_financing": 793378204.08,
    "net_annual_pre_financing": 358525962.22,
    "cumulative_interim_payment": 4997782236.19,
    "recovery_of_expense": 4078814.76,
    "net_interim_payment": 5266945765.67,
    "total_net_payment": 5902481682.48,
    "eu_payment_rate": 62.7326293665512,
    "eu_payment_rate_on_planned_eu_amount": 62.7239173020556
},
{
    "ms": "RO",
    "ms_name": "Romania",
    "fund": "ERDF",
    "year": "2023",
    "planned_eu_amount": 12376137876,
    "n_3_decommitment_amount": 0,
    "net_planned_eu_amount": 12376137876,
    "cumulative_initial_pre_financing": 868546842.66,
    "cumulative_additional_initial_pre_financing": 0,
    "recovery_of_initial_pre_financing": 0,
    "net_initial_pre_financing": 868546842.66,
    "cumulative_annual_pre_financing": 2048832083.97,
    "annual_pre_financing_covered_by_expenditure": 502203928.85,
    "recovery_of_annual_pre_financing": 1077148628.61,
    "net_annual_pre_financing": 1338026369.17,
    "cumulative_interim_payment": 9459260360.08,
    "recovery_of_expense": 11907266.25,
    "net_interim_payment": 9949557022.68,
    "total_net_payment": 11287583391.85,
    "eu_payment_rate": 91.2044088789529,
    "eu_payment_rate_on_planned_eu_amount": 91.2044088789529
},
{
    "ms": "TC",
    "ms_name": "Interreg",
    "fund": "ERDF",
    "year": "2021",
    "planned_eu_amount": 9410256783,
    "n_3_decommitment_amount": -1306860,
    "net_planned_eu_amount": 9408949923,
    "cumulative_initial_pre_financing": 277009954.59,
    "cumulative_additional_initial_pre_financing": 0,
    "recovery_of_initial_pre_financing": 0,
    "net_initial_pre_financing": 277009954.59,
    "cumulative_annual_pre_financing": 1425146510.54,
    "annual_pre_financing_covered_by_expenditure": 273242344.24,
    "recovery_of_annual_pre_financing": 793378204.08,
    "net_annual_pre_financing": 635535916.809999,
    "cumulative_interim_payment": 4997782236.19,
    "recovery_of_expense": 4078814.76,
    "net_interim_payment": 5266945765.67,
    "total_net_payment": 5902481682.48,
    "eu_payment_rate": 62.7326293665512,
    "eu_payment_rate_on_planned_eu_amount": 62.7239173020556
},
{
    "ms": "NL",
    "ms_name": "Netherlands",
    "fund": "ERDF",
    "year": "2023",
    "planned_eu_amount": 791056051,
    "n_3_decommitment_amount": 0,
    "net_planned_eu_amount": 791056051,
    "cumulative_initial_pre_financing": 47368625.97,
    "cumulative_additional_initial_pre_financing": 0,
    "recovery_of_initial_pre_financing": 0,
    "net_initial_pre_financing": 47368625.97,
    "cumulative_annual_pre_financing": 109683026.38,
    "annual_pre_financing_covered_by_expenditure": 29936191.64,
    "recovery_of_annual_pre_financing": 56352761.21,
    "net_annual_pre_financing": 70762699.5,
    "cumulative_interim_payment": 492457164.67,
    "recovery_of_expense": 0,
    "net_interim_payment": 522393356.31,
    "total_net_payment": 593156055.81,
    "eu_payment_rate": 74.9828100120304,
    "eu_payment_rate_on_planned_eu_amount": 74.9828100120304
},
{
    "ms": "FI",
    "ms_name": "Finland",
    "fund": "ERDF",
    "year": "2023",
    "planned_eu_amount": 911500186,
    "n_3_decommitment_amount": 0,
    "net_planned_eu_amount": 911500186,
    "cumulative_initial_pre_financing": 36354536.76,
    "cumulative_additional_initial_pre_financing": 0,
    "recovery_of_initial_pre_financing": 0,
    "net_initial_pre_financing": 36354536.76,
    "cumulative_annual_pre_financing": 145781633.4,
    "annual_pre_financing_covered_by_expenditure": 50489421.84,
    "recovery_of_annual_pre_financing": 66551480.54,
    "net_annual_pre_financing": 65095267.78,
    "cumulative_interim_payment": 746086862.62,
    "recovery_of_expense": 0,
    "net_interim_payment": 796576284.46,
    "total_net_payment": 861671552.24,
    "eu_payment_rate": 94.5333380590226,
    "eu_payment_rate_on_planned_eu_amount": 94.5333380590226
},    
{
    "ms": "LV",
    "ms_name": "Latvia",
    "fund": "CF",
    "year": "2023",
    "planned_eu_amount": 1246634592,
    "n_3_decommitment_amount": 0,
    "net_planned_eu_amount": 1246634592,
    "cumulative_initial_pre_financing": 38053494.39,
    "cumulative_additional_initial_pre_financing": 0,
    "recovery_of_initial_pre_financing": 0,
    "net_initial_pre_financing": 38053494.39,
    "cumulative_annual_pre_financing": 242867675.75,
    "annual_pre_financing_covered_by_expenditure": 26728833.24,
    "recovery_of_annual_pre_financing": 157051202.55,
    "net_annual_pre_financing": 97141134.35,
    "cumulative_interim_payment": 932556402.72,
    "recovery_of_expense": 1582884.99,
    "net_interim_payment": 957702350.97,
    "total_net_payment": 1054843485.32,
    "eu_payment_rate": 84.6152908068831,
    "eu_payment_rate_on_planned_eu_amount": 84.6152908068831
}, 
{
    "ms": "FI",
    "ms_name": "Finland",
    "fund": "TOTAL",
    "year": "2023",
    "planned_eu_amount": 911500186,
    "n_3_decommitment_amount": 0,
    "net_planned_eu_amount": 911500186,
    "cumulative_initial_pre_financing": 36354536.76,
    "cumulative_additional_initial_pre_financing": 0,
    "recovery_of_initial_pre_financing": 0,
    "net_initial_pre_financing": 36354536.76,
    "cumulative_annual_pre_financing": 145781633.4,
    "annual_pre_financing_covered_by_expenditure": 50489421.84,
    "recovery_of_annual_pre_financing": 66551480.54,
    "net_annual_pre_financing": 28740731.02,
    "cumulative_interim_payment": 746086862.62,
    "recovery_of_expense": 0,
    "net_interim_payment": 796576284.46,
    "total_net_payment": 861671552.24,
    "eu_payment_rate": 94.5333380590226,
    "eu_payment_rate_on_planned_eu_amount": 94.5333380590226
},
{
    "ms": "RO",
    "ms_name": "Romania",
    "fund": "TOTAL",
    "year": "2023",
    "planned_eu_amount": 18911134853,
    "n_3_decommitment_amount": 0,
    "net_planned_eu_amount": 18911134853,
    "cumulative_initial_pre_financing": 1129302729.02,
    "cumulative_additional_initial_pre_financing": 0,
    "recovery_of_initial_pre_financing": 0,
    "net_initial_pre_financing": 1129302729.02,
    "cumulative_annual_pre_financing": 3304685776.16,
    "annual_pre_financing_covered_by_expenditure": 801498614.69,
    "recovery_of_annual_pre_financing": 1729543863.68,
    "net_annual_pre_financing": 773643297.79,
    "cumulative_interim_payment": 15130042993.6,
    "recovery_of_expense": 11907266.25,
    "net_interim_payment": 15919634342.04,
    "total_net_payment": 17822580368.85,
    "eu_payment_rate": 94.2438436793373,
    "eu_payment_rate_on_planned_eu_amount": 94.2438436793373
},
{
    "ms": "TC",
    "ms_name": "Interreg",
    "fund": "TOTAL",
    "year": "2023",
    "planned_eu_amount": 9410256783,
    "n_3_decommitment_amount": -10176032,
    "net_planned_eu_amount": 9400080751,
    "cumulative_initial_pre_financing": 277009954.59,
    "cumulative_additional_initial_pre_financing": 0,
    "recovery_of_initial_pre_financing": 0,
    "net_initial_pre_financing": 277009954.59,
    "cumulative_annual_pre_financing": 1788194898.31,
    "annual_pre_financing_covered_by_expenditure": 551390235.8,
    "recovery_of_annual_pre_financing": 890070455.82,
    "net_annual_pre_financing": 623744161.28,
    "cumulative_interim_payment": 7394234778.84,
    "recovery_of_expense": 12068759.85,
    "net_interim_payment": 7933556254.79,
    "total_net_payment": 8557300416.07,
    "eu_payment_rate": 91.0343287759486,
    "eu_payment_rate_on_planned_eu_amount": 90.9358863780328
},
{
    "ms": "PL",
    "ms_name": "Poland",
    "fund": "TOTAL",
    "year": "2021",
    "planned_eu_amount": 64879004975,
    "n_3_decommitment_amount": 0,
    "net_planned_eu_amount": 64879004975,
    "cumulative_initial_pre_financing": 1943386912.05,
    "cumulative_additional_initial_pre_financing": 0,
    "recovery_of_initial_pre_financing": 0,
    "net_initial_pre_financing": 1943386912.05,
    "cumulative_annual_pre_financing": 9174735397.44,
    "annual_pre_financing_covered_by_expenditure": 2451786154.8,
    "recovery_of_annual_pre_financing": 4528755140.49,
    "net_annual_pre_financing": 2194194102.15,
    "cumulative_interim_payment": 43093589060.6,
    "recovery_of_expense": 103369931.05,
    "net_interim_payment": 45442005284.35,
    "total_net_payment": 49579586298.55,
    "eu_payment_rate": 76.4185368096422,
    "eu_payment_rate_on_planned_eu_amount": 76.4185368096422
},
{
    "ms": "TC",
    "ms_name": "Interreg",
    "fund": "ERDF",
    "year": "2023",
    "planned_eu_amount": 9410256783,
    "n_3_decommitment_amount": -10176032,
    "net_planned_eu_amount": 9400080751,
    "cumulative_initial_pre_financing": 277009954.59,
    "cumulative_additional_initial_pre_financing": 0,
    "recovery_of_initial_pre_financing": 0,
    "net_initial_pre_financing": 277009954.59,
    "cumulative_annual_pre_financing": 1788194898.31,
    "annual_pre_financing_covered_by_expenditure": 551390235.8,
    "recovery_of_annual_pre_financing": 890070455.82,
    "net_annual_pre_financing": 623744161.28,
    "cumulative_interim_payment": 7394234778.84,
    "recovery_of_expense": 12068759.85,
    "net_interim_payment": 7933556254.79,
    "total_net_payment": 8557300416.07,
    "eu_payment_rate": 91.0343287759486,
    "eu_payment_rate_on_planned_eu_amount": 90.9358863780328
},
{
    "ms": "ES",
    "ms_name": "Spain",
    "fund": "ERDF",
    "year": "2024",
    "planned_eu_amount": 29101440102,
    "n_3_decommitment_amount": -2111646,
    "net_planned_eu_amount": 29099328456,
    "cumulative_initial_pre_financing": 1684672125.11,
    "cumulative_additional_initial_pre_financing": 0,
    "recovery_of_initial_pre_financing": 21531983.27,
    "net_initial_pre_financing": 1663140141.84,
    "cumulative_annual_pre_financing": 3957618233.99,
    "annual_pre_financing_covered_by_expenditure": 885647559.69,
    "recovery_of_annual_pre_financing": 2113635928.38,
    "net_annual_pre_financing": 2621474887.76,
    "cumulative_interim_payment": 18921672906.51,
    "recovery_of_expense": 205667492.77,
    "net_interim_payment": 19601652973.43,
    "total_net_payment": 22223127861.19,
    "eu_payment_rate": 76.3698993768628,
    "eu_payment_rate_on_planned_eu_amount": 76.3643578575437
},
{
    "ms": "PL",
    "ms_name": "Poland",
    "fund": "CF",
    "year": "2023",
    "planned_eu_amount": 23139930966,
    "n_3_decommitment_amount": 0,
    "net_planned_eu_amount": 23139930966,
    "cumulative_initial_pre_financing": 654465290.97,
    "cumulative_additional_initial_pre_financing": 0,
    "recovery_of_initial_pre_financing": 0,
    "net_initial_pre_financing": 654465290.97,
    "cumulative_annual_pre_financing": 4278864643.08,
    "annual_pre_financing_covered_by_expenditure": 1766188362.8,
    "recovery_of_annual_pre_financing": 1672423470.16,
    "net_annual_pre_financing": 1494718101.09,
    "cumulative_interim_payment": 19879218152.72,
    "recovery_of_expense": 193650.61,
    "net_interim_payment": 21645212864.91,
    "total_net_payment": 23139930966,
    "eu_payment_rate": 100,
    "eu_payment_rate_on_planned_eu_amount": 100
},
{
    "ms": "DE",
    "ms_name": "Germany",
    "fund": "ERDF",
    "year": "2021",
    "planned_eu_amount": 11935900615,
    "n_3_decommitment_amount": 0,
    "net_planned_eu_amount": 11935900615,
    "cumulative_initial_pre_financing": 433390687.37,
    "cumulative_additional_initial_pre_financing": 0,
    "recovery_of_initial_pre_financing": 0,
    "net_initial_pre_financing": 433390687.37,
    "cumulative_annual_pre_financing": 1566948256.07,
    "annual_pre_financing_covered_by_expenditure": 295221665.66,
    "recovery_of_annual_pre_financing": 847985689.92,
    "net_annual_pre_financing": 857131587.86,
    "cumulative_interim_payment": 5482316726.95,
    "recovery_of_expense": 1748307.95,
    "net_interim_payment": 5775790084.66,
    "total_net_payment": 6632921672.52,
    "eu_payment_rate": 55.5711871811694,
    "eu_payment_rate_on_planned_eu_amount": 55.5711871811694
},
{
    "ms": "ES",
    "ms_name": "Spain",
    "fund": "TOTAL",
    "year": "2024",
    "planned_eu_amount": 29101440102,
    "n_3_decommitment_amount": -2111646,
    "net_planned_eu_amount": 29099328456,
    "cumulative_initial_pre_financing": 1684672125.11,
    "cumulative_additional_initial_pre_financing": 0,
    "recovery_of_initial_pre_financing": 21531983.27,
    "net_initial_pre_financing": 1663140141.84,
    "cumulative_annual_pre_financing": 3957618233.99,
    "annual_pre_financing_covered_by_expenditure": 885647559.69,
    "recovery_of_annual_pre_financing": 2113635928.38,
    "net_annual_pre_financing": 2621474887.76,
    "cumulative_interim_payment": 18921672906.51,
    "recovery_of_expense": 205667492.77,
    "net_interim_payment": 19601652973.43,
    "total_net_payment": 22223127861.19,
    "eu_payment_rate": 76.3698993768628,
    "eu_payment_rate_on_planned_eu_amount": 76.3643578575437
},

{
    "ms": "LU",
    "ms_name": "Luxembourg",
    "fund": "ERDF",
    "year": 2023,
    "planned_eu_amount": 89189782,
    "n_3_decommitment_amount": 0,
    "net_planned_eu_amount": 89189782,
    "cumulative_initial_pre_financing": 11003074.62,
    "cumulative_additional_initial_pre_financing": 0,
    "recovery_of_initial_pre_financing": 0,
    "net_initial_pre_financing": 11003074.62,
    "cumulative_annual_pre_financing": 6386663.66,
    "annual_pre_financing_covered_by_expenditure": 2902451.64,
    "recovery_of_annual_pre_financing": 1505632.02,
    "net_annual_pre_financing": 12981654.62,
    "cumulative_interim_payment": 66370779.13,
    "recovery_of_expense": 830013.35,
    "net_interim_payment": 68443217.42,
    "total_net_payment": 81424872.04,
    "eu_payment_rate": 91.2939466989615,
    "eu_payment_rate_on_planned_eu_amount": 91.2939466989615
}]



const API_BASE = "/api/v1";

module.exports = (app, db) => {

    app.get(API_BASE + "/structural-payment-data/loadInitialData", (req,res) => {
        db.insert(datos);
        res.sendStatus(200, "Ok");
    });

//Implementación de los métodos de la tabla azul

    //POST - VERIFICAR SI LOS DATOS YA EXISTEN EN LA BASE DE DATOS
    app.post(API_BASE + "/structural-payment-data", (req, res) => {
        let dataInitial = req.body;
    
        db.find({ ms_name: dataInitial.ms_name }, (err, data) => {
            if (err) {
                res.sendStatus(500, "Internal Error");
            }
    
            if (data.length > 0) {
                res.sendStatus(409, "Conflict");
            } else if (!dataInitial || Object.keys(dataInitial).length === 0) {
                res.sendStatus(400, "Bad Request");
            } else {
                db.insert(dataInitial, (err, newData) => {
                    if (err) {
                        res.sendStatus(500, "Internal Error");
                    }
                    res.sendStatus(201, "Created");
                });
            }
        });
    });

    //GET - LISTA TODOS LOS DATOS
    app.get(API_BASE+"/structural-payment-data", (req, res)=>{
        db.find({}, (err, data)=>{
            if(err){
                res.sendStatus(500, "Internal Error");
            } else{
                res.send(JSON.stringify(data));
            }
        });
    });

    //PUT - NO PERMITIDO
    app.put(API_BASE + "/structural-payment-data", (req, res) => {
        let data = req.body;
        res.sendStatus(405, "Method not allowed");
    });

    //DELETE - BORRA TODOS LOS DATOS
    app.delete(API_BASE + "/structural-payment-data", (req, res) => {
        db.remove({}, {multi:true}, (err, numRemoved)=>{
            if(err){
                res.sendStatus(500, "Internal Error");
                return;
            }else{
                if(numRemoved>=1){
                    res.sendStatus(200, "Ok");
                }else{
                    res.sendStatus(404, "Not found");
                }
            }
        });
    });

    //POST - NO PERMITIDO
    app.post(API_BASE + "/structural-payment-data/:country", (req, res) => {
        const pais = req.params.ms_name;
        let data = req.body;
        res.sendStatus(405, "Method Not Allowed");
    });

    //GET - DATOS DE UN PAIS
    app.get(API_BASE + "/structural-payment-data/:ms_name", (req, res) => {
        let pais = req.params.ms_name;

        db.find({ ms_name: pais }, (err, countryData) => {
            if (err) {
                res.sendStatus(500, "Internal Server Error");
            }
            if (countryData.length > 0) {
                res.send(JSON.stringify(countryData.map((c)=>{
                    delete c._id;
                    return c;
                }))); // Devolver los datos encontrados
            } else {
                res.sendStatus(404, "Not Found"); //Datos no existentes
            }
        });
    });

    //PUT - ACTUALIZAR DATOS
    app.put(API_BASE+"/structural-payment-data/:ms_name", (req,res) => {
        let countryToUpdate = req.params.ms_name;
        let newData = req.body;

        db.update({ "ms_name": countryToUpdate }, { $set : newData}, (err,numUpdated) => {
          if (err) {
            res.sendStatus(500, "Internal server error");
        } else {
            if (numUpdated === 0) {
                res.sendStatus(400, "Bad request");
            } else {
                res.sendStatus(200, "Ok");
            }
          }
        });
      });

    //DELETE - BORRA DATOS DE UN PAIS
    app.delete(API_BASE + "/structural-payment-data/:ms_name", (req, res) => {
        let country = req.params.ms_name;
        db.remove({"ms_name": country}, {}, (err, numRemoved)=>{
            if(err){
                res.sendStatus(500, "Internal Error");
            }else{
                if(numRemoved>=1){
                    res.sendStatus("200", "OK");
                }else{
                    res.sendStatus("404", "Not found");
                }
            }
        });
    });

}
